<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Preview Test - aiNote</title>
    <link rel="stylesheet" href="./src/js/components/preview-renderer.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .test-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .panel-header {
            background: #007acc;
            color: white;
            padding: 12px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-content {
            height: 600px;
            overflow: hidden;
        }
        .editor-area {
            width: 100%;
            height: 100%;
            border: none;
            padding: 20px;
            font-family: 'Monaco', 'Cascadia Code', monospace;
            font-size: 14px;
            resize: none;
            outline: none;
        }
        .preview-area {
            height: 100%;
            overflow-y: auto;
            padding: 20px;
        }
        .stats {
            background: #f8f9fa;
            padding: 10px 20px;
            border-top: 1px solid #e1e4e8;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        .btn:hover {
            background: #005a9e;
        }
        .btn.secondary {
            background: #6c757d;
        }
        .btn.secondary:hover {
            background: #545b62;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h1>Real-time Preview Test - Issue #49</h1>
        <button class="btn" onclick="loadSampleContent()">Load Sample Content</button>
        <button class="btn secondary" onclick="clearContent()">Clear</button>
        <button class="btn secondary" onclick="toggleTheme()">Toggle Theme</button>
        <button class="btn secondary" onclick="showStats()">Show Performance Stats</button>
    </div>

    <div class="test-container">
        <!-- Editor Panel -->
        <div class="test-panel">
            <div class="panel-header">
                <span>Markdown Editor</span>
                <span id="editor-status">Ready</span>
            </div>
            <div class="panel-content">
                <textarea class="editor-area" id="editor" placeholder="Type your markdown here...

# Try these features:
- Real-time preview updates (200ms debounce)
- Scroll synchronization
- Performance monitoring
- Large document incremental parsing

## Code blocks
\`\`\`javascript
function hello() {
  console.log('Hello from aiNote!');
}
\`\`\`

## Tables
| Feature | Status | Performance Target |
|---------|--------|--------------------|
| Real-time updates | âœ… | <200ms |
| Incremental parsing | âœ… | <50ms |
| Memory optimization | âœ… | <1MB/hour |

## Links and Images
[aiNote GitHub](https://github.com/iPixx/ainote)

![aiNote Demo](https://via.placeholder.com/400x200/007acc/white?text=aiNote+Demo)

## Performance Test
Try typing a large document to test incremental parsing and memory optimization!"></textarea>
            </div>
            <div class="stats" id="editor-stats">
                <span>Characters: 0</span>
                <span>Lines: 0</span>
                <span>Real-time: Disabled</span>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="test-panel">
            <div class="panel-header">
                <span>Real-time Preview</span>
                <span id="preview-status">Ready</span>
            </div>
            <div class="panel-content">
                <div class="preview-area" id="preview"></div>
            </div>
            <div class="stats" id="preview-stats">
                <span>Renders: 0</span>
                <span>Memory: 0MB</span>
                <span>Last Update: 0ms</span>
            </div>
        </div>
    </div>

    <script type="module">
        import PreviewRenderer from './src/js/components/preview-renderer.js';

        // Mock AppState for testing
        class MockAppState extends EventTarget {
            constructor() {
                super();
                this.state = { viewMode: 'editor' };
            }
            
            emit(event, data) {
                this.dispatchEvent(new CustomEvent(event, { detail: data }));
            }
        }

        // Mock MarkdownEditor for testing
        class MockMarkdownEditor extends EventTarget {
            constructor(textarea) {
                super();
                this.textarea = textarea;
                this.content = '';
                
                // Listen to textarea changes
                this.textarea.addEventListener('input', (e) => {
                    this.content = e.target.value;
                    this.dispatchEvent(new CustomEvent('content_changed', {
                        detail: { content: this.content }
                    }));
                    
                    // Update stats
                    this.updateStats();
                });
            }
            
            getValue() {
                return this.textarea.value;
            }
            
            setValue(content) {
                this.textarea.value = content;
                this.content = content;
                this.updateStats();
            }
            
            updateStats() {
                const content = this.textarea.value;
                const lines = content.split('\n').length;
                const chars = content.length;
                
                document.getElementById('editor-stats').innerHTML = 
                    `<span>Characters: ${chars}</span>
                     <span>Lines: ${lines}</span>
                     <span>Real-time: ${window.previewRenderer?.realTimeEnabled ? 'Enabled' : 'Disabled'}</span>`;
            }
        }

        // Initialize test environment
        const mockAppState = new MockAppState();
        const editorTextarea = document.getElementById('editor');
        const previewContainer = document.getElementById('preview');
        
        // Create mock editor
        const mockEditor = new MockMarkdownEditor(editorTextarea);
        
        // Create preview renderer
        const previewRenderer = new PreviewRenderer(previewContainer, mockAppState);
        window.previewRenderer = previewRenderer; // For debugging
        
        // Enable real-time updates
        previewRenderer.enableRealTimeUpdates(mockEditor, editorTextarea);
        
        // Update status indicators
        document.getElementById('editor-status').textContent = 'Connected';
        document.getElementById('preview-status').textContent = 'Real-time Active';
        
        // Performance monitoring
        let renderCount = 0;
        const originalRender = previewRenderer.render.bind(previewRenderer);
        previewRenderer.render = async function(content) {
            const startTime = performance.now();
            renderCount++;
            
            await originalRender(content);
            
            const duration = performance.now() - startTime;
            const memoryMB = performance.memory ? 
                (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2) : 'N/A';
            
            document.getElementById('preview-stats').innerHTML = 
                `<span>Renders: ${renderCount}</span>
                 <span>Memory: ${memoryMB}MB</span>
                 <span>Last Update: ${duration.toFixed(1)}ms</span>`;
        };
        
        // Test functions
        window.loadSampleContent = function() {
            const sampleContent = `# Real-time Preview Test - Issue #49

This is a comprehensive test of the real-time preview functionality implemented for aiNote.

## Features Tested âœ…

### 1. Real-time Updates (200ms debounce)
- Type in the editor and see updates after 200ms of inactivity
- Efficient change detection prevents unnecessary re-renders
- Content hashing ensures only actual changes trigger updates

### 2. Performance Optimization
- **Target**: <50ms for incremental updates
- **Target**: <1MB per hour memory growth  
- **Target**: <200ms update latency after typing stops

### 3. Scroll Synchronization (Preparation)
- Infrastructure ready for editor-preview scroll sync
- 5px tolerance for smooth synchronization
- Bidirectional sync support

## Advanced Features

### Code Syntax Highlighting
\`\`\`javascript
// Real-time preview update implementation
async performRealTimeUpdate(content) {
  if (this.pendingUpdate) return;
  
  const startTime = performance.now();
  // ... implementation
  const updateTime = performance.now() - startTime;
  
  if (updateTime > 50) {
    console.warn(\`Update exceeded target: \${updateTime}ms\`);
  }
}
\`\`\`

### Tables with Alignment
| Component | Status | Performance | Memory |
|-----------|:------:|:-----------:|-------:|
| Parser | âœ… | <50ms | <2MB |
| Renderer | âœ… | <50ms | <3MB |
| Real-time | âœ… | <200ms | <1MB/h |
| Scroll Sync | ðŸ”„ | <16ms | <0.1MB |

### Links and Navigation
- [GitHub Issue #49](https://github.com/iPixx/ainote/issues/49)
- [Parent Issue #6](https://github.com/iPixx/ainote/issues/6)
- Internal link example: [scroll-sync](#scroll-synchronization-preparation)

### Images with Responsive Sizing
![Test Image](https://via.placeholder.com/600x300/007acc/white?text=Real-time+Preview+Working!)

### Blockquotes and Lists
> Real-time preview updates provide immediate feedback to users while maintaining excellent performance characteristics.

**Key Performance Targets:**
1. **Update Latency**: <200ms after typing stops
2. **Rendering Time**: <50ms for incremental updates  
3. **Memory Growth**: <1MB per hour of continuous editing
4. **Scroll Sync Accuracy**: <5px offset tolerance

### Large Document Test
${'Lorem ipsum '.repeat(100)}

This large content block tests:
- Incremental parsing for documents >1000 lines
- Memory optimization and cleanup
- Performance monitoring and warnings
- Efficient change detection

## Implementation Details

The real-time preview system includes:

- **Debounced Updates**: 200ms delay after typing stops
- **Content Hashing**: Efficient change detection  
- **Incremental Parsing**: For large documents (>50KB)
- **Memory Monitoring**: Automatic cleanup when needed
- **Performance Tracking**: Real-time statistics
- **Scroll Infrastructure**: Ready for synchronization

Try editing this content to see the real-time updates in action!`;

            mockEditor.setValue(sampleContent);
            previewRenderer.render(sampleContent);
        };
        
        window.clearContent = function() {
            mockEditor.setValue('');
            previewRenderer.clear();
        };
        
        window.toggleTheme = function() {
            document.body.classList.toggle('dark-theme');
        };
        
        window.showStats = function() {
            const stats = previewRenderer.getPerformanceStats();
            alert(JSON.stringify(stats, null, 2));
        };
        
        console.log('âœ… Real-time Preview Test initialized');
        console.log('ðŸ“Š Preview Renderer:', previewRenderer);
        console.log('ðŸ”§ Features: Real-time updates, Performance monitoring, Memory optimization');
    </script>
</body>
</html>