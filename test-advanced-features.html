<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Features Test - aiNote</title>
    <link rel="stylesheet" href="./src/styles.css">
    <link rel="stylesheet" href="./src/js/components/preview-renderer.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: var(--color-bg-secondary, #f5f5f5);
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        .test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .test-panel {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            height: 600px;
        }
        
        .panel-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
        }
        
        .markdown-input {
            width: 100%;
            height: calc(100% - 50px);
            border: none;
            padding: 15px;
            font-family: Monaco, 'Cascadia Code', monospace;
            font-size: 14px;
            resize: none;
            outline: none;
        }
        
        .preview-output {
            height: calc(100% - 50px);
            overflow: hidden;
        }
        
        .test-controls {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .test-controls button {
            margin: 0 10px;
            padding: 8px 16px;
            border: 1px solid #007acc;
            background: #007acc;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .test-controls button:hover {
            background: #005a9e;
        }
        
        .performance-stats {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: Monaco, monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-controls">
        <h1>Advanced Markdown Features Test</h1>
        <button onclick="loadTestMarkdown()">Load Test Content</button>
        <button onclick="testExport()">Test HTML Export</button>
        <button onclick="testPerformance()">Performance Test</button>
        <button onclick="clearPreview()">Clear</button>
    </div>
    
    <div class="test-container">
        <div class="test-panel">
            <div class="panel-header">Markdown Input</div>
            <textarea class="markdown-input" id="markdown-input" 
                      placeholder="Enter markdown here to test advanced features..."></textarea>
        </div>
        
        <div class="test-panel">
            <div class="panel-header">Preview Output</div>
            <div class="preview-output" id="preview-output"></div>
        </div>
    </div>
    
    <div class="performance-stats" id="performance-stats">
        Performance Stats:<br>
        Render Time: 0ms<br>
        Memory Usage: 0MB<br>
        Total Renders: 0
    </div>

    <script type="module">
        import PreviewRenderer from './src/js/components/preview-renderer.js';

        // Initialize the preview renderer
        const previewContainer = document.getElementById('preview-output');
        const markdownInput = document.getElementById('markdown-input');
        const performanceStats = document.getElementById('performance-stats');
        
        // Mock app state for testing
        const mockAppState = {
            emit: (event, data) => {
                console.log('App State Event:', event, data);
            }
        };
        
        const renderer = new PreviewRenderer(previewContainer, mockAppState);
        
        // Real-time preview updates
        let updateTimeout;
        markdownInput.addEventListener('input', () => {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(async () => {
                const markdown = markdownInput.value;
                await renderer.render(markdown);
                updatePerformanceStats();
            }, 300);
        });
        
        // Update performance stats display
        function updatePerformanceStats() {
            const stats = renderer.getPerformanceStats();
            performanceStats.innerHTML = `
                Performance Stats:<br>
                Render Time: ${stats.averageRenderTime}ms<br>
                Max Render: ${stats.maxRenderTime}ms<br>
                Memory Usage: ${stats.memoryUsage}MB<br>
                Total Renders: ${stats.totalRenders}
            `;
        }
        
        // Load test markdown content
        window.loadTestMarkdown = async () => {
            try {
                const response = await fetch('./test-advanced-features.md');
                const markdown = await response.text();
                markdownInput.value = markdown;
                await renderer.render(markdown);
                updatePerformanceStats();
                console.log('‚úÖ Test content loaded and rendered');
            } catch (error) {
                console.error('‚ùå Failed to load test content:', error);
                // Fallback test content
                const testMarkdown = `# Test Content

## Table Test
| Feature | Status | Performance |
|:--------|:------:|-----------:|
| Tables | ‚úÖ Working | Fast |
| Links | ‚úÖ Working | Fast |
| Images | ‚úÖ Working | Fast |

## Link Test
- [External Link](https://github.com)
- [Anchor Link](#table-test)

## Image Test
![Test](https://picsum.photos/300/200)

## Code Test
\`\`\`javascript
console.log("Hello World!");
\`\`\`
`;
                markdownInput.value = testMarkdown;
                await renderer.render(testMarkdown);
                updatePerformanceStats();
            }
        };
        
        // Test HTML export functionality
        window.testExport = async () => {
            try {
                const startTime = performance.now();
                const html = await renderer.exportToHTML({
                    title: 'Test Export',
                    includeStyles: true,
                    includeMetadata: true,
                    theme: 'light'
                });
                const exportTime = performance.now() - startTime;
                
                console.log('‚úÖ HTML Export completed in ' + exportTime.toFixed(2) + 'ms');
                console.log('Exported HTML length:', html.length);
                
                // Create download link
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'test-export.html';
                link.click();
                URL.revokeObjectURL(url);
                
                alert('Export completed in ' + exportTime.toFixed(2) + 'ms!\nFile downloaded as test-export.html');
                
            } catch (error) {
                console.error('‚ùå Export failed:', error);
                alert('Export failed: ' + error.message);
            }
        };
        
        // Performance stress test
        window.testPerformance = async () => {
            const testSizes = [100, 500, 1000, 5000, 10000];
            const results = [];
            
            for (const size of testSizes) {
                const testMarkdown = generateTestMarkdown(size);
                const startTime = performance.now();
                await renderer.render(testMarkdown);
                const renderTime = performance.now() - startTime;
                
                results.push({
                    lines: size,
                    renderTime: renderTime.toFixed(2)
                });
                
                console.log('üìä ' + size + ' lines rendered in ' + renderTime.toFixed(2) + 'ms');
            }
            
            updatePerformanceStats();
            
            const report = results.map(r => r.lines + ' lines: ' + r.renderTime + 'ms').join('\n');
            alert('Performance Test Results:\n' + report);
        };
        
        // Generate test markdown of specified line count
        function generateTestMarkdown(lines) {
            let content = '# Performance Test\n\n';
            
            for (let i = 0; i < lines; i++) {
                if (i % 50 === 0) {
                    content += '## Section ' + (Math.floor(i/50) + 1) + '\n\n';
                }
                if (i % 10 === 0) {
                    content += '| Col 1 | Col 2 | Col 3 |\n|-------|-------|-------|\n';
                    content += '| Data ' + i + ' | Value ' + i + ' | Result ' + i + ' |\n\n';
                } else {
                    content += 'This is line ' + (i + 1) + ' with **bold** and *italic* text and [link](https://example.com).\n\n';
                }
            }
            
            return content;
        }
        
        // Clear preview
        window.clearPreview = () => {
            markdownInput.value = '';
            renderer.clear();
            updatePerformanceStats();
        };
        
        // Load test content on page load
        window.addEventListener('load', () => {
            setTimeout(window.loadTestMarkdown, 500);
        });
        
        console.log('üöÄ Advanced Features Test initialized');
        console.log('üìù Use the controls above to test different features');
    </script>
</body>
</html>