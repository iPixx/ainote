<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppState Test Suite</title>
    <style>
        body { 
            font-family: monospace; 
            max-width: 800px; 
            margin: 40px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .test-result { 
            padding: 8px 12px; 
            margin: 4px 0; 
            border-radius: 4px; 
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .section { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            border: 1px solid #007bff; 
            background: #007bff; 
            color: white; 
            border-radius: 4px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>AppState Test Suite</h1>
    
    <div class="section">
        <h2>Manual Tests</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
        <div id="test-results"></div>
    </div>

    <div class="section">
        <h2>Interactive Demo</h2>
        <button onclick="demoVaultOperations()">Demo Vault Operations</button>
        <button onclick="demoFileOperations()">Demo File Operations</button>
        <button onclick="demoViewModeToggle()">Demo View Mode Toggle</button>
        <button onclick="demoDirtyState()">Demo Dirty State</button>
        <button onclick="demoEventListeners()">Demo Event System</button>
        <div id="demo-results"></div>
    </div>

    <script type="module">
        import AppState from './state.js';

        // Global test state
        let testCount = 0;
        let passCount = 0;
        let appState;

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('test-results').appendChild(div);
            console.log(message);
        }

        function logDemo(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('demo-results').appendChild(div);
            console.log(message);
        }

        function assert(condition, message) {
            testCount++;
            if (condition) {
                passCount++;
                log(`✅ PASS: ${message}`, 'pass');
            } else {
                log(`❌ FAIL: ${message}`, 'fail');
            }
        }

        function assertEquals(actual, expected, message) {
            const condition = actual === expected;
            assert(condition, `${message} (expected: ${expected}, actual: ${actual})`);
        }

        function testBasicInitialization() {
            log('--- Testing Basic Initialization ---', 'info');
            appState = new AppState();
            
            assert(appState !== null, 'AppState instance created');
            assertEquals(appState.currentVault, null, 'currentVault initialized to null');
            assertEquals(appState.currentFile, null, 'currentFile initialized to null');
            assertEquals(appState.viewMode, AppState.VIEW_MODES.EDITOR, 'viewMode initialized to EDITOR');
            assertEquals(appState.unsavedChanges, false, 'unsavedChanges initialized to false');
            assert(Array.isArray(appState.files), 'files initialized as array');
            assertEquals(appState.files.length, 0, 'files array is empty');
        }

        function testVaultOperations() {
            log('--- Testing Vault Operations ---', 'info');
            
            // Test setting vault
            appState.setVault('/test/vault/path');
            assertEquals(appState.currentVault, '/test/vault/path', 'setVault updates currentVault');
            
            // Test setting vault to null
            appState.setVault(null);
            assertEquals(appState.currentVault, null, 'setVault can set to null');
        }

        function testFileOperations() {
            log('--- Testing File Operations ---', 'info');
            
            appState.setCurrentFile('/test/file.md');
            assertEquals(appState.currentFile, '/test/file.md', 'setCurrentFile updates currentFile');
            
            appState.setCurrentFile(null);
            assertEquals(appState.currentFile, null, 'setCurrentFile can set to null');
        }

        function testViewModeOperations() {
            log('--- Testing View Mode Operations ---', 'info');
            
            // Test setting explicit mode
            appState.setViewMode(AppState.VIEW_MODES.PREVIEW);
            assertEquals(appState.viewMode, AppState.VIEW_MODES.PREVIEW, 'setViewMode updates viewMode');
            
            // Test toggle
            const newMode = appState.toggleViewMode();
            assertEquals(newMode, AppState.VIEW_MODES.EDITOR, 'toggleViewMode returns new mode');
            assertEquals(appState.viewMode, AppState.VIEW_MODES.EDITOR, 'toggleViewMode updates state');
            
            // Test invalid mode
            try {
                appState.setViewMode('invalid_mode');
                assert(false, 'setViewMode should throw error for invalid mode');
            } catch (error) {
                assert(true, 'setViewMode throws error for invalid mode');
            }
        }

        function testDirtyState() {
            log('--- Testing Dirty State Operations ---', 'info');
            
            appState.markDirty(true);
            assertEquals(appState.unsavedChanges, true, 'markDirty(true) sets unsavedChanges to true');
            
            appState.markDirty(false);
            assertEquals(appState.unsavedChanges, false, 'markDirty(false) sets unsavedChanges to false');
            
            appState.markDirty(); // Default is true
            assertEquals(appState.unsavedChanges, true, 'markDirty() defaults to true');
        }

        function testFilesOperations() {
            log('--- Testing Files Operations ---', 'info');
            
            const testFiles = [
                { name: 'test1.md', is_dir: false },
                { name: 'folder1', is_dir: true },
                { name: 'test2.md', is_dir: false }
            ];
            
            appState.setFiles(testFiles);
            assertEquals(appState.files.length, 3, 'setFiles updates files array');
            assertEquals(appState.files[0].name, 'test1.md', 'files array contains correct data');
            
            // Test invalid input
            try {
                appState.setFiles('not an array');
                assert(false, 'setFiles should throw error for non-array input');
            } catch (error) {
                assert(true, 'setFiles throws error for non-array input');
            }
        }

        function testEventSystem() {
            log('--- Testing Event System ---', 'info');
            
            let eventFired = false;
            let eventData = null;
            
            const handler = (data) => {
                eventFired = true;
                eventData = data;
            };
            
            // Test adding and firing event
            appState.addEventListener(AppState.EVENTS.VAULT_CHANGED, handler);
            appState.setVault('/event/test/path');
            
            assert(eventFired, 'Event listener fired when vault changed');
            assertEquals(eventData.vault, '/event/test/path', 'Event data contains correct vault path');
            
            // Test removing event listener
            eventFired = false;
            appState.removeEventListener(AppState.EVENTS.VAULT_CHANGED, handler);
            appState.setVault('/another/path');
            
            assert(!eventFired, 'Event listener not fired after removal');
        }

        function testStateValidation() {
            log('--- Testing State Validation ---', 'info');
            
            assert(appState.isValid(), 'Valid state returns true');
            
            // Test invalid view mode
            appState.viewMode = 'invalid';
            assert(!appState.isValid(), 'Invalid view mode returns false');
            appState.viewMode = AppState.VIEW_MODES.EDITOR; // Reset
            
            // Test invalid unsavedChanges
            appState.unsavedChanges = 'not boolean';
            assert(!appState.isValid(), 'Invalid unsavedChanges type returns false');
            appState.unsavedChanges = false; // Reset
            
            // Test invalid files
            appState.files = 'not array';
            assert(!appState.isValid(), 'Invalid files type returns false');
            appState.files = []; // Reset
            
            assert(appState.isValid(), 'State valid after reset');
        }

        function testPersistence() {
            log('--- Testing Persistence ---', 'info');
            
            // Clear localStorage first
            localStorage.removeItem('aiNote_appState');
            
            appState.setVault('/persistence/test');
            appState.setCurrentFile('/persistence/test/file.md');
            appState.setViewMode(AppState.VIEW_MODES.PREVIEW);
            
            // Create new instance to test loading
            const newAppState = new AppState();
            
            assertEquals(newAppState.currentVault, '/persistence/test', 'Vault persisted to localStorage');
            assertEquals(newAppState.currentFile, '/persistence/test/file.md', 'File persisted to localStorage');
            assertEquals(newAppState.viewMode, AppState.VIEW_MODES.PREVIEW, 'View mode persisted to localStorage');
            
            // Note: unsavedChanges and files should NOT persist
            assertEquals(newAppState.unsavedChanges, false, 'unsavedChanges not persisted (correct)');
            assertEquals(newAppState.files.length, 0, 'files not persisted (correct)');
        }

        function testReset() {
            log('--- Testing Reset Functionality ---', 'info');
            
            // Set some state
            appState.setVault('/reset/test');
            appState.setCurrentFile('/reset/test/file.md');
            appState.setViewMode(AppState.VIEW_MODES.PREVIEW);
            appState.markDirty(true);
            appState.setFiles([{name: 'test.md', is_dir: false}]);
            
            // Reset
            appState.reset();
            
            assertEquals(appState.currentVault, null, 'Reset clears vault');
            assertEquals(appState.currentFile, null, 'Reset clears file');
            assertEquals(appState.viewMode, AppState.VIEW_MODES.EDITOR, 'Reset sets view mode to default');
            assertEquals(appState.unsavedChanges, false, 'Reset clears dirty state');
            assertEquals(appState.files.length, 0, 'Reset clears files');
            
            // Check localStorage cleared
            const saved = localStorage.getItem('aiNote_appState');
            assertEquals(saved, null, 'Reset clears localStorage');
        }

        window.runAllTests = function() {
            testCount = 0;
            passCount = 0;
            document.getElementById('test-results').innerHTML = '';
            
            log('Starting AppState Test Suite...', 'info');
            
            testBasicInitialization();
            testVaultOperations();
            testFileOperations();
            testViewModeOperations();
            testDirtyState();
            testFilesOperations();
            testEventSystem();
            testStateValidation();
            testPersistence();
            testReset();
            
            const successRate = ((passCount / testCount) * 100).toFixed(1);
            if (passCount === testCount) {
                log(`🎉 ALL TESTS PASSED! (${passCount}/${testCount} - ${successRate}%)`, 'pass');
            } else {
                log(`⚠️ Some tests failed: ${passCount}/${testCount} passed (${successRate}%)`, 'fail');
            }
        };

        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('demo-results').innerHTML = '';
        };

        // Demo functions
        window.demoVaultOperations = function() {
            logDemo('--- Vault Operations Demo ---', 'info');
            const demo = new AppState();
            
            demo.addEventListener(AppState.EVENTS.VAULT_CHANGED, (data) => {
                logDemo(`Event: Vault changed to ${data.vault}`, 'pass');
            });
            
            demo.setVault('/demo/vault/path');
            logDemo(`Current vault: ${demo.getState().currentVault}`, 'info');
        };

        window.demoFileOperations = function() {
            logDemo('--- File Operations Demo ---', 'info');
            const demo = new AppState();
            
            demo.addEventListener(AppState.EVENTS.FILE_CHANGED, (data) => {
                logDemo(`Event: File changed to ${data.file}`, 'pass');
            });
            
            demo.setCurrentFile('/demo/file.md');
            logDemo(`Current file: ${demo.getState().currentFile}`, 'info');
        };

        window.demoViewModeToggle = function() {
            logDemo('--- View Mode Toggle Demo ---', 'info');
            const demo = new AppState();
            
            demo.addEventListener(AppState.EVENTS.VIEW_MODE_CHANGED, (data) => {
                logDemo(`Event: View mode changed to ${data.mode}`, 'pass');
            });
            
            logDemo(`Initial mode: ${demo.viewMode}`, 'info');
            const newMode = demo.toggleViewMode();
            logDemo(`After toggle: ${newMode}`, 'info');
            demo.toggleViewMode();
            logDemo(`After second toggle: ${demo.viewMode}`, 'info');
        };

        window.demoDirtyState = function() {
            logDemo('--- Dirty State Demo ---', 'info');
            const demo = new AppState();
            
            demo.addEventListener(AppState.EVENTS.DIRTY_STATE_CHANGED, (data) => {
                logDemo(`Event: Dirty state changed to ${data.isDirty}`, 'pass');
            });
            
            demo.markDirty(true);
            logDemo(`After marking dirty: ${demo.unsavedChanges}`, 'info');
            demo.markDirty(false);
            logDemo(`After marking clean: ${demo.unsavedChanges}`, 'info');
        };

        window.demoEventListeners = function() {
            logDemo('--- Event System Demo ---', 'info');
            const demo = new AppState();
            
            let eventCount = 0;
            const counter = () => {
                eventCount++;
                logDemo(`Event #${eventCount} fired`, 'pass');
            };
            
            // Add multiple event types
            demo.addEventListener(AppState.EVENTS.VAULT_CHANGED, counter);
            demo.addEventListener(AppState.EVENTS.FILE_CHANGED, counter);
            demo.addEventListener(AppState.EVENTS.VIEW_MODE_CHANGED, counter);
            
            demo.setVault('/event/demo');
            demo.setCurrentFile('/event/demo/file.md');
            demo.toggleViewMode();
            
            logDemo(`Total events fired: ${eventCount}`, 'info');
        };

        // Initialize
        log('AppState Test Suite loaded. Click "Run All Tests" to begin.', 'info');
    </script>
</body>
</html>